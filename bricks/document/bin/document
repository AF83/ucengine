#!/usr/bin/env ruby

require 'rubygems'
require 'tempfile'

require 'ucengine'

lib_dir = File.join(File.dirname(__FILE__), '..', 'lib')
$:.unshift(File.expand_path(lib_dir))
require 'ucengine_document'

config = UCEngine.load_config

UCEngine.run('document') do
  include UCEngineDocument
  begin
    uce = UCEngine.new(config['host'], config['port'], config['debug'])
      uce.connect(config['uid'], :credential => config['credential']) do |uce|
      uce.subscribe([], :type => "internal.file.add", :start => uce.time) do |event|
        # TODO: use a thread pool
        Thread.new do
          handle_upload_event(uce, event)
        end
      end
    end
  rescue => error
    puts "Fatal error: #{error}"
    puts error.backtrace
    puts "Retry in 5 seconds ..."
    sleep(5)
    retry
  end
end
